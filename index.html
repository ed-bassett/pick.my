<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<script src="./instafeed.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript">


(function(){
  if (typeof window.performance === 'undefined') {
      window.performance = {};
  }
  if (!window.performance.now){
    var nowOffset = Date.now();
    if (performance.timing && performance.timing.navigationStart){
      nowOffset = performance.timing.navigationStart
    }
    window.performance.now = function now(){
      return Date.now() - nowOffset;
    }
   }
})();


imagesPerLoad = 5;

var tags = [
{name:'Chinese',tags:['chinesefoodporn','chinesefoods','chinesecuisine']},
{name:'Indian',tags:['Indianfood','indianfoods']},
{name:'Mexican',tags: ['Mexicanfood','mexicanfoodporn','mexicangourmet','mexicancuisine']},
{name:'Japanese',tags:['japanesefood','japanesefoodporn','japanesecuisine']},
{name:'Korean',tags:['Koreanfoods','koreanfoodie']},
{name:'Fusion',tags:['fusioncuisine','fusionfood']},
{name:'Russian',tags:['Russianfood','Russiancuisine']},
{name:'Italian',tags:['Italianfoods','Italianfoodporn']},
{name:'Vegan',tags:['Veganfood','veganfoodlove']},
{name:'Vegetarian',tags:['vegetarianfood','vegetarianfoodporn']},
{name:'Malaysian',tags:['Malaysianfood','Malaysianfoods']},
{name:'Filipino',tags:['filipinofood','filipinocuisine']},
{name:'Indonesian',tags:['indonesianfood','indonesianfoods']},
{name:'Thai',tags:['Thaifood','thaifoods','thaifoodstyle']},
{name:'Greek',tags:['greekfood','greeksalad']},
{name:'Salad',tags:['salad','salads','saladporn']},
{name:'Sandwich',tags:['cutesandwich','sandwichporn','vietnamesesandwich']},
{name:'Fruits',tags:['fruits','fruitsalad','fruitbowl']},
{name:'Breakfast all day',tags:['gourmetbreakfast','healthybreakfast','breakfast']},
{name:'Healthy',tags:['healthfoodporn','healthyfoodporn','healthyfoodshare']},
{name:'Low fat',tags:['lowfat','lowfatdiet','lowfatfood']},
{name:'Low Carb',tags:['lowcarb','lowcarbfood']},
{name:'Burger',tags:['burger','burgerporn']},
{name:'Baked',tags:['bakedgoods','ovenbaked','cookies']},
{name:'Fried',tags:['Friedfood','fried','friedstuff']},
{name:'Steamed',tags:['steamed','steamedfood','steamfood']},
{name:'Stew',tags:['stew','hotpot']},
{name:'Roast',tags:['roastdinner','roasties']},
{name:'Rice',tags:['ricedish','friedrice','mixedrice']},
{name:'Noodles',tags: ['noodlesoup','noodle','noodles']},
{name:'Soup',tags: ['soup','soups']},
{name:'Instant Noodles',tags:['Instantnoodle','Instantnoodles']},
{name:'Vietnamese',tags:['Vietnamesefood','vietnamesecuisine','vietnamesesandwich']},
{name:'Spanish',tags:['Spanishfood','spanishcuisine']},
{name:'French',tags:['Frenchfood','Frenchcuisine']},
{name:'German',tags:['Germanfood','germancuisine']},
{name:'African',tags:['Africanfood','Africancuisine','Africanfoodporn']},
{name:'Junk food',tags:['junkfoods','junkfoodporn']},
{name:'Comfort Food',tags:['Comfortfood','comfortfoods']},
{name:'Fine Dining',tags:['finedining','finedinning','finedine']},
{name:'Cake',tags:['cakes','gourmetcake']},
{name:'Ethiopian',tags:['ethiopianfood','ethiopiancuisine']},
{name:'Gourmet',tags:['gourmetfood','gourmetdinner','plating']},
{name:'Turkish',tags: ['turkishfood','turkishcuisine']},
{name:'Lebanese',tags:['lebanesecuisine','lebanesefood','lebanesefoods']},
{name:'Dessert',tags:['dessertporn','sweets','chocolates','icecream']},
];



var termsOfUse = "TERMS OF USE\n\
Instagram is not a sponsor nor is involved in any way with Pickture app.\n\
\n\
App Vantage Pty Ltd provides Pickture App (herein referred to as &ldquo;the App&rdquo;) subject to your compliance with the terms and conditions set forth in our Terms of Use. By using the App, you agree to be bound by these terms and conditions. If you do not agree to these terms and conditions, please do not use the App.\n\
\n\
App Vantage Pty Ltd reserve the right at any time to:\n\
Change the terms and conditions.\n\
Change the App, including eliminating or discontinuing any content on or functionality of the App.\n\
\n\
(1) Code of conduct.\n\
While using the App (as defined below), you agree not to:\n\
Restrict or inhibit any other user from using the App;\n\
Transmit any content or information that is unlawful, fraudulent, threatening, abusive, libelous, defamatory, obscene or otherwise objectionable, or infringes on App Vantage Pty Ltd or any third partyâ€™s intellectual property or other rights;\n\
Use the App for any unlawful purpose;\n\
Modify, adapt, sub-license, translate, sell, reverse engineer, decompile or disassemble any portion of the App;\n\
Harvest or collect information about other App users without their express consent; or use any robot, spider, site search/retrieval application, or other manual or automatic device or process to retrieve, index, &ldquo;data mine&rdquo;, or in any way reproduce or circumvent the navigational structure or presentation of the App or its contents.\n\
While using the App, you agree to comply with all applicable laws, rules and regulations. We have no obligation to monitor the App or any materials that you transmit to the App. However, you acknowledge and agree that we have the right to monitor the App and the materials you transmit, and to disclose any information to any third party in order to operate the App properly; to protect App Vantage Pty Ltd and our visitors.\n\
You are limited to registering one Instagram account with Pickture App per device.\n\
\n\
(2) Ownership and restrictions on use of materials.\n\
The App is owned and operated by App Vantage Pty Ltd. Except for where your own Instagram photos are concerned, you may not copy, reproduce, republish, upload, post, transmit or distribute materials from the App in any way. You acknowledge that you do not acquire any ownership rights by using the App.\n\
App Vantage Pty Ltd does NOT claim ANY ownership rights in the text, files, images, photos, video, sounds, musical works, works of authorship, applications, or any other materials (collectively, &ldquo;Content&rdquo;) that you post on or through the Pickture App. By entering any Picktures (&ldquo;posting&rdquo;) and any Content on or through Pickture App, you hereby grant to App Vantage Pty Ltd a non-exclusive, fully paid and royalty-free, worldwide, limited license to use, modify, delete from, add to, publicly perform, publicly display, reproduce and translate such Content, including without limitation distributing part or all of the Site in any media formats through any media channels.\n\
App Vantage Pty Ltd does not copy or store any of your entered photos. As such, any photos deleted from your Instagram profile will also cease to appear in the App. This includes any entries in current or previous rounds and winner entries, and credits incurred will not be refunded.\n\
\n\
(3) Indemnification\n\
You agree to indemnify, defend and hold App Vantage Pty Ltd , our officers, directors, employees, agents and representatives harmless from and against any and all claims, damages, losses, or other expenses that arise directly or indirectly out of or from (a) your breach of this Agreement, including without limitation, any violation of the Code of Conduct set forth in Paragraph 1 of Section 1; (b) any allegation that any materials that you submit to us or transmit to the App infringe or otherwise violate the copyright, trademark, trade secret or other intellectual property or other rights of, or defame, any third party; and/or (c) your activities in connection with the App.\n\
&copy; 2012 App Vantage Pty Ltd. All rights reserved.";


rand = function (i) {
  return Math.floor(Math.random() * (i + 1));
}

function animate (start,end,duration,ease,onUpdate,onEnd) {
  var startTime = window.performance.now();
  var id = 0;
  var ended = false;
  callback  = function (timestamp) {
    if ( ended ) { return; }
    var timeFraction = (timestamp - startTime) / duration;
    if ( timeFraction >= 1 ) {
      ended = true;
      onUpdate(end);
      onEnd();
      return;
    }
    switch(ease) {
      case 'ease-out':
        timeFraction = Math.pow(timeFraction,.5);
        break;
    }
    onUpdate(start + (end - start) * timeFraction);
    id = window.requestAnimationFrame(callback);
  };
  callback(startTime);
}

function Item (arg) {
  var self = this;
  var name;
  var tags;
  var imgContainer;
  var feed;
  var label;
  this.init = function (arg) {
    self.name = arg.name;
    self.tags = arg.tags;

    self.imgContainer = $('<div id="item_' + self.name + '">');

    $('#feeds').append(self.imgContainer);

    self.feed = new Instafeed({
        get: 'tagged',
        tagName: this.tags[rand(this.tags.length-1)],
        clientId: 'a07275a5d7734d7a8b18cc5fed9fe97b',
        target: 'item_' + self.name,
        sortBy: 'random',
        limit: 5,
        resolution: 'standard_resolution',
    });
  };
  this.init(arg);
};

function WheelManager () {
  var self = this;
  var wheel;
  var items;
  var selected;
  var popup;
  var likeDecisions;
  var likes;
  var notLikes;
  var blockInteract;
  var imagesSeen;
  var randomPool;
  var initialTouchAngle;
  var initialAngle;
  var lastAngle;
  var lastTime;
  var currentOffset;
  var angularVelocity;
  var sections;

this.calcAngle = function (touch) {
  x = (touch.pageX-self.wheel.offset().left-self.wheel.width()/2)/self.wheel.width()*2;
  y = (touch.pageY-self.wheel.offset().top-self.wheel.height()/2)/self.wheel.height()*2;
  angle = Math.atan2(y,x)/Math.PI*180;
  if (angle > 180 ) {
    angle = angle=angle-360;
  }
  return angle;
};
this.calcRadius = function (touch) {
  x = (touch.pageX-self.wheel.offset().left-self.wheel.width()/2)/self.wheel.width()*2;
  y = (touch.pageY-self.wheel.offset().top-self.wheel.height()/2)/self.wheel.height()*2;
  radius = Math.sqrt(Math.pow(x,2) + Math.pow(y,2));
  return radius;
};

  this.wheelAngle = function () {
    return self.lastAngle - self.initialAngle;
  }
  this.addSwipeToWheel = function () {
    self.angularVelocity=0;
    self.initialTouchAngle = 0;
    self.lastAngle = 0;
    self.currentOffset = 0;

    self.wheel.on('touchstart', function (jqevent) {
      jqevent.preventDefault();
      self.reset();
      self.hidePopup();
      self.angularVelocity=0;
      e = jqevent.originalEvent;
      if ( e.changedTouches.length == 1 ) {
        self.initialTouchAngle = self.calcAngle(e.changedTouches[0]);
        self.initialAngle = self.selected/tags.length*360 + self.currentOffset;
        self.lastAngle = 0;
        self.lastTime = e.timeStamp;
      }
    });

    self.wheel.on('touchmove',function (jqevent) {
      jqevent.preventDefault();
      e = jqevent.originalEvent;
      if ( e.changedTouches.length == 1 ) {
        angle = self.calcAngle(e.changedTouches[0])-self.initialTouchAngle;
        radius = self.calcRadius(e.changedTouches[0]);
        deltaAngle = angle - self.lastAngle;
        deltaAngle = deltaAngle % 360;
        if ( deltaAngle > 180 ) {
          deltaAngle -= 360;
        }
        if ( deltaAngle < -180 ) {
          deltaAngle += 360;
        }
        deltaTime = e.timeStamp - self.lastTime;
        self.angularVelocity = (self.angularVelocity*.3 + deltaAngle/deltaTime*.7);
        self.lastAngle = angle;
        self.lastTime  = e.timeStamp;
        self.sections.css('-webkit-transform', 'rotate(' + (angle - self.initialAngle) + 'deg)');
      }
    });

    self.wheel.on('touchend',function (jqevent) {
      jqevent.preventDefault();

      if ( e.changedTouches.length == 1 ) {
        radius = self.calcRadius(e.changedTouches[0]);

        totalSpin = Math.pow(Math.abs(self.angularVelocity),1/3)*self.angularVelocity*360*4*radius;

        if ( Math.abs(totalSpin) > 2000 ) {
          if ( totalSpin > 0 ) {
            totalSpin = 2000;
          } else {
            totalSpin = -2000;
          }
        }

        rotations = totalSpin/360;
        endAngle = Math.round((self.lastAngle - self.initialAngle + rotations*360)/(360/tags.length))*(360/tags.length);
        self.currentOffset = self.currentOffset - self.lastAngle;
        if ( Math.abs(totalSpin) >= 45 ) {
          self.selected = Math.round(((0-endAngle) % 360 + 360) / 360 * tags.length) % tags.length;
          console.log(self.selectedItem().tagName);
          self.currentOffset = 0;

          duration = 1000+1000*(Math.abs(rotations)/2);
          animate(
            self.lastAngle-self.initialAngle,
            endAngle,
            duration,
            'ease-out',
            function (rotAngle) {self.sections.css('-webkit-transform', 'rotate(' + (rotAngle) + 'deg)');},
            self.showOption
          );

          self.selectedItem().feed.run();
          self.blockInteraction();
        } else {
          popupContent = $('<div class="content">');
          buttonBar = $('<div class="buttonBar">');
          button = $('<div class="button">')
            .on('click',self.hidePopup)
            .html('OK')
            .addClass('default')
            ;
          buttonBar.append(button);
          spinFaster = $('<span>Spin Faster!</span>');
          popupContent.append(spinFaster);
          //popupContent.append(buttonBar);
          self.showPopup(popupContent,'spinFaster');
        }
      }
    });
  };

  this.init = function () {
    self.selected=0;
    self.wheel = $('#wheel');
    self.popup = $('#popup');
    self.blockInteract = $('#blockInteract');
    self.items = [];
    self.likeDecisions = 0;
    self.likes = [];
    self.notLikes = [];
    self.imagesSeen = 0;
    self.seedRandomPool();
    self.addSwipeToWheel();

    $('#feeds').html('');
    self.wheel.html('');
    //self.hidePopup();

    originalLength = tags.length;
    randomTags = [];
    while (randomTags.length<originalLength) {
      tag = tags.splice(rand(tags.length-1),1);
      randomTags.push(tag[0]);
    }
    tags = randomTags;
    sections = $('<div id="sections">');
    for (var i=0;i<tags.length;i++){
      self.items[i] = new Item(tags[i]);
      label = $('<div class="section" style="-webkit-transform: translateY(-50%) rotateZ('+(i*360/tags.length+90)+'deg)"><div class="section-content">' + tags[i].name + '</div></div>');
      sections.append(label);
      self.items[i].label = label;
    }
    self.sections = sections;
    self.wheel.append(sections);
    self.showInspire();
  };

  this.seedRandomPool = function () {
    self.randomPool = [];
    for(i=0;i<tags.length;i++) {
      self.randomPool[i] = i;
    }
  }

  this.button = function (id,text,onClick) {
    return $('<div class="button">')
      .attr('id',id)
      .html(text)
      .on('click',onClick)
      .on('click',function(){ga('send','event','button','click',id)})
      ;
  }

this.blockInteraction = function () {
  self.blockInteract.css('display','block');
}

this.unblockInteraction = function () {
  self.blockInteract.css('display','none');
}

  this.showTerms = function () {
    popupContent = $('<div class="content">');
    popupContent.append($('<div id="termsOfUse">').on('click',self.showInspire).html(termsOfUse));
    self.showPopup(popupContent);
  }

  this.showInspire = function () {
    popupContent = $('<div class="content">');
    buttonBar = $('<div class="buttonBar">').append(self.button('inspire','Pick My Lunch',self.spin).addClass('default'));
    arrow = $('<div class="popupArrow">');
    popupContent.append(arrow);
    popupContent.append(buttonBar);
    legals = $('<div id="legalsText">').html('This product uses the Instagram API but is not endorsed or certified by Instagram. ');
    terms = $('<span>Terms of Use</span>').on('click',self.showTerms);
    legals.append(terms);
    popupContent.append(legals);
    self.showPopup(popupContent,'inspire');
  };

  this.showPopup = function (content,idClass) {
    if(idClass != null) {
      self.popup.attr('class','');
      self.popup.addClass(idClass);
    } else {
      self.popup.attr('class','');
    }
    self.popup.html(content);
    self.popup.css('display','-webkit-flex');
    self.popup.css('display','flex');
    self.popup.removeClass('hidden');
  };

  this.hidePopup = function () {
    //self.popup.css('display','none');
    self.popup.addClass('hidden');
  };

  this.reset = function () {
    self.sections.find('.section').removeClass('selected');
    self.likeDecisions = 0;
    self.likes = [];
    self.notLikes = [];
    self.imagesSeen = 0;
    self.selectedItem().imgContainer.html('');
  };

  this.reSpin = function () {
    self.reset();
    popupContent = $('<div class="content">');
    arrow = $('<div class="popupArrow">');
    popupContent.append(arrow);
    self.showPopup(popupContent);
    self.spin();
  };

  this.spin = function () {
    self.hidePopup();

    randomPoolIndex = rand(self.randomPool.length-1);
    lastSelected = self.selected;
    self.selected = self.randomPool.splice(randomPoolIndex,1);
    if ( self.randomPool.length == 0 ) {
      self.seedRandomPool();
    }

    self.sections.animateRotate(
      -(360/tags.length)*lastSelected,
      -360-(360/tags.length)*self.selected,
      2000,
      'swing',
      self.showOption
    );
    self.selectedItem().feed.run();
    self.blockInteraction();
  };

  this.selectedItem = function () {
    return self.items[self.selected];
  };

  this.showOption = function () {
    self.unblockInteraction();
    self.selectedItem().label.addClass('selected');
    popupContent = $('<div class="content">');

    buttonBar = $('<div class="buttonBar">');
    buttonBar.append(self.button('picknow','Pick now',self.showSelected).addClass('default'));
    buttonBar.append(self.button('pickagain','Pick again?',self.reSpin));

    arrow = $('<div class="popupArrow">');
    popupContent.append(arrow);
    popupContent.append(buttonBar);

    self.showPopup(popupContent,"option");
  };

  this.selectedImage = function (num) {
    return $(self.selectedItem().imgContainer.find('a')[num]).find('img');
  }
  this.showSelected = function () {
    self.imagesSeen ++;
    if ( (self.imagesSeen  + 1) % imagesPerLoad == 0 ) {
      self.selectedItem().feed.next();
    }

    popupContent = $('<div class="content">');
    popupContent.append($('<span class="title">').html(self.selectedItem().name ));
    selectedImage = self.selectedImage(self.likeDecisions);
    image = $('<img>').attr('src',selectedImage.attr('src'));
    imageContainer = $('<div class="imageContainer">').append(image);
    popupContent.append(imageContainer);

    buttonBar = $('<div class="buttonBar">');
    buttonBar.append(self.button('like','I like',function () {self.addLiked(self.likeDecisions)}).addClass('default'));
    buttonBar.append(self.button('nolike','I don\'t like',self.addNotLiked));

    popupContent.append(buttonBar);

    self.showPopup(popupContent,'pickNow');
  };

  this.showSummary = function () {
    popupContent = $('<div class="content">');
    imageContainer = $('<div class="imageContainer">');
    itemsPerRow = 2;
    rowImage = 0;

    grid = [];
    rowItems = []
    itemCounter=0;
    addToGrid = function (item) {
      rowItems.push(item);
      if (rowItems.length == itemsPerRow) {
        grid.push(rowItems);
        rowItems = [];
      }
    }
    for(i=0;i<self.likes.length;i++) {
      addToGrid($('<img>').attr('src',self.selectedImage(self.likes[i]).attr('src')));
    }
    moreInspiration = $('<div class="textImage"><span>Pick again?</span></div>').on('click',self.reSpin).on('click',function(){ga('send','event','button','click','pickagainimage')});
    addToGrid(moreInspiration);

    gridNode = $('<div class="grid">');
    for ( rowNum = 0; rowNum < grid.length; rowNum++ ) {
      row = grid[rowNum];
      rowNode = $('<div class="row">');
      for ( rowItemNum = 0; rowItemNum < row.length; rowItemNum++ ) {
        rowNode.append(row[rowItemNum]);
      }
      gridNode.append(rowNode);
    }

    imageContainer.append(gridNode);
    popupContent.append(imageContainer);

    ;
    buttonBar = $('<div class="buttonBar">').append(
      self.button('inspire','Share',self.showShare).addClass('default')
    );
    popupContent.append(buttonBar);
    self.showPopup(popupContent);
  }

  this.showShare = function () {
    FB.ui({
      name: 'pick.my/lunch/',
      method: 'feed',
      link: 'http://pick.my/lunch/',
      caption: 'Lunch sorted - pick.my/lunch/',
      picture: 'http:' + self.selectedImage(self.likes[0]).attr('src'),
    }, function(response){});
  };

  this.addLiked = function (num) {
    self.likeDecisions++;
    self.likes.push(num);
    if ( self.likes.length == 3 ) {
      self.showSummary();
    } else {
      self.showSelected();
    }
  };
  this.addNotLiked = function () {
    self.likeDecisions++;
    self.showSelected();
  };
  this.init();
};

var test;
var wheelMan;

$.fn.animateRotate = function(start,angle, duration, easing, complete) {
    return this.each(function() {
        var $elem = $(this);

        $({deg: start}).animate({deg: angle}, {
            duration: duration,
            easing: easing,
            step: function(now) {
                $elem.css({
                    transform: 'rotate(' + now + 'deg)'
                });
            },
            complete: complete || $.noop
        });
    });
};

$('document').ready(function () {
  wheelMan = new WheelManager();
});
</script>
<link rel="stylesheet" type="text/css" href="./style.css">
</head>
<body>
<script>
        window.fbAsyncInit = function() {
        FB.init({
          appId      : '741988392514495',
          xfbml      : true,
          version    : 'v2.0'
        });
      };

      (function(d, s, id){
         var js, fjs = d.getElementsByTagName(s)[0];
         if (d.getElementById(id)) {return;}
         js = d.createElement(s); js.id = id;
         js.src = "//connect.facebook.net/en_US/sdk.js";
         fjs.parentNode.insertBefore(js, fjs);
       }(document, 'script', 'facebook-jssdk'));
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42565224-3', 'devsketchpad-dev.s3.amazonaws.com');
  ga('send', 'pageview');

</script>
<div id="arrowContainer"><div id="arrow"></div><div id="arrowContent"></div></div>
<div id="wheelContainer"><div id="wheel"><div id="sections"></div></div></div>
<div id="popup"><div id="content"></div></div>
<div id="feeds" style="display:none;"></div>
<div id="blockInteract"></div>
</body>
</html>
